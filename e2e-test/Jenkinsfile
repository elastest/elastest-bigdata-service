def elastest_url = ''
node('et_in_et'){
    elastest(tss: ['EUS'], surefireReportsPattern: '**/target/surefire-reports/TEST-*.xml', project: 'ETinET', sut: 11) {        
        stage ('docker container')
            def mycontainer = docker.image('elastest/ebs-spark:latest')
            mycontainer.pull()
            mycontainer.inside()  {
                
                stage ('prepare test')
                    git 'https://github.com/elastest/elastest-bigdata-service.git'
                    elastest_url = env.ET_SUT_PROTOCOL + '://' + env.ET_SUT_HOST + ':' + env.ET_SUT_PORT
                sh "env | sort"    
                stage ("Run tests")
                    try {
                         sh "git clone https://github.com/elastest/demo-projects.git;cd demo-projects/ebs-test;mvn package;rm -f big.txt;wget https://norvig.com/big.txt;hadoop fs  -rm /out.txt;hadoop fs -rm /big.txt;hadoop fs -copyFromLocal big.txt /big.txt;spark-submit --class org.sparkexample.WordCountTask --master spark://sparkmaster:7077 /demo-projects/ebs-test/target/hadoopWordCount-1.0-SNAPSHOT.jar /big.txt;hadoop fs -getmerge /out.txt ./out.txt;head -20 out.txt"
                        } catch(e) {
                        echo 'Err: ' + e.toString()
                    } 
            }
    }
}
